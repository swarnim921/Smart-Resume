<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <style>
        /* Minimal invisible page - user won't see this */
        body {
            margin: 0;
            padding: 0;
            background: #f8fafc;
        }
    </style>
</head>

<body>
    <script>
        // Immediate execution - no delays
        (function () {
            try {
                // Get token from URL
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                const name = urlParams.get('name');
                const email = urlParams.get('email');

                if (!token) {
                    console.error('OAuth Success - No token provided');
                    window.location.replace('/smart_resume_signin_page.html');
                    return;
                }

                // üî• CRITICAL: Decode role from JWT (NOT from URL parameter)
                // JWT is the ONLY source of truth
                let role = 'candidate'; // default fallback
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    console.log('üîç OAuth Success - JWT Payload:', payload);
                    console.log('üîç OAuth Success - JWT Payload (stringified):', JSON.stringify(payload, null, 2));

                    // Extract role from JWT
                    if (payload.role) {
                        role = payload.role.toLowerCase().replace('role_', '');
                        console.log('‚úÖ OAuth Success - Role from JWT:', role);
                    } else {
                        console.warn('‚ö†Ô∏è OAuth Success - No role in JWT payload, using default:', role);
                    }

                    console.log('üîç OAuth Success - Final role after processing:', role);
                } catch (e) {
                    console.error('‚ùå OAuth Success - Failed to decode JWT:', e);
                }

                // Store in localStorage
                localStorage.setItem('token', token);
                localStorage.setItem('user', JSON.stringify({
                    name: name ? decodeURIComponent(name) : 'User',
                    email: email ? decodeURIComponent(email) : '',
                    role: role
                }));
                console.log('üíæ OAuth Success - Stored in localStorage:', { name, email, role });

                // Determine dashboard URL based on JWT role
                const dashboardFile = role === 'recruiter' ? 'recruiter-dashboard.html' : 'candidate-dashboard.html';
                console.log('üöÄ OAuth Success - Redirecting to:', dashboardFile);
                console.log('üîç OAuth Success - Role check: role===\'recruiter\'?', role === 'recruiter');

                // IMMEDIATE redirect using replace (doesn't add to history)
                window.location.replace(`/${dashboardFile}`);
            } catch (error) {
                // Fallback on any error
                console.error('OAuth redirect error:', error);
                window.location.replace('/smart_resume_signin_page.html');
            }
        })();
    </script>
</body>

</html>