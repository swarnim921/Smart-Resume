pipeline {
    agent any
    
    environment {
        ML_HOST = credentials('talentsync-ml-host')
    }
    
    stages {
        stage('Check Changes') {
            steps {
                script {
                    def changes = sh(returnStdout: true, script: 'git diff --name-only HEAD~1 || echo "ml-service/"').trim()
                    if (!changes.contains('ml-service/')) {
                        echo '✅ No ML changes detected. Skipping build.'
                        currentBuild.result = 'NOT_BUILT'
                        error('No ML changes - skipping')
                    }
                }
            }
        }
        
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Deploy to EC2') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'upi-ec2-key', keyFileVariable: 'SSH_KEY_FILE')]) {
                    sh '''
                        # Deploy ML service files
                        scp -i ${SSH_KEY_FILE} -o StrictHostKeyChecking=no -r \
                            ml-service/* ec2-user@${ML_HOST}:/home/ec2-user/ml-service/
                        
                        # Install dependencies and restart service
                        ssh -i ${SSH_KEY_FILE} -o StrictHostKeyChecking=no ec2-user@${ML_HOST} \
                            "cd /home/ec2-user/ml-service && pip3 install -r requirements.txt && sudo systemctl restart ml-service || true"
                        
                        echo "✅ ML service deployed successfully!"
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo '✅ ML deployment successful!'
        }
        failure {
            echo '❌ ML deployment failed!'
        }
    }
}
