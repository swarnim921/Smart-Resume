pipeline {
    agent any
    
    environment {
        FRONTEND_HOST = credentials('talentsync-frontend-host')
    }
    
    stages {
        stage('Check Changes') {
            steps {
                script {
                    def changes = sh(returnStdout: true, script: 'git diff --name-only HEAD~1 || echo "frontend/"').trim()
                    if (!changes.contains('frontend/') && !changes.contains('.html') && !changes.contains('.css') && !changes.contains('.js')) {
                        echo '✅ No frontend changes detected. Skipping build.'
                        currentBuild.result = 'NOT_BUILT'
                        error('No frontend changes - skipping')
                    }
                }
            }
        }
        
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Deploy to EC2') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'upi-ec2-key', keyFileVariable: 'SSH_KEY_FILE')]) {
                    sh '''
                        # Deploy HTML/CSS/JS files from correct location
                        scp -i ${SSH_KEY_FILE} -o StrictHostKeyChecking=no \
                            src/main/resources/static/*.html \
                            src/main/resources/static/*.css \
                            src/main/resources/static/*.js \
                            ec2-user@${FRONTEND_HOST}:/var/www/html/ 2>/dev/null || true
                        
                        # Restart nginx
                        ssh -i ${SSH_KEY_FILE} -o StrictHostKeyChecking=no ec2-user@${FRONTEND_HOST} \
                            "sudo systemctl restart nginx"
                        
                        echo "✅ Frontend deployed successfully!"
                    '''
                }
            }
        }
    }
    
    post {
        success {
            echo '✅ Frontend deployment successful!'
        }
        failure {
            echo '❌ Frontend deployment failed!'
        }
    }
}
